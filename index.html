import React, { useState } from 'react';
import { Plus, Search, Calendar, ShoppingCart, Printer, Upload, X, Edit2, Trash2, ExternalLink, Copy } from 'lucide-react';

const RecipeManager = () => {
  const [recipes, setRecipes] = useState([]);
  const [view, setView] = useState('recipes');
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedKeywords, setSelectedKeywords] = useState([]);
  const [editingRecipe, setEditingRecipe] = useState(null);
  const [mealPlan, setMealPlan] = useState([]);
  const [shoppingList, setShoppingList] = useState([]);
  const [showExportModal, setShowExportModal] = useState(false);
  const [exportData, setExportData] = useState('');
  const [showImportModal, setShowImportModal] = useState(false);
  const [showMealPlanModal, setShowMealPlanModal] = useState(false);
  const [selectedRecipeForPlan, setSelectedRecipeForPlan] = useState(null);
  const [printRecipe, setPrintRecipe] = useState(null);
  const [mealPlanView, setMealPlanView] = useState('rolling'); // 'rolling', 'thisWeek', 'nextWeek', 'twoWeeks'
  const [printMealPlan, setPrintMealPlan] = useState(false);
  const [printShoppingList, setPrintShoppingList] = useState(false);

  // Auto-delete old meals on load
  React.useEffect(() => {
    const today = new Date().toISOString().split('T')[0];
    setMealPlan(prev => prev.filter(meal => meal.date >= today));
  }, []);

  const handleExport = (includeImages = false) => {
    let exportRecipes = recipes;
    if (!includeImages) {
      exportRecipes = recipes.map(r => {
        const { image, ...recipeWithoutImage } = r;
        return recipeWithoutImage;
      });
    }
    const data = { recipes: exportRecipes, mealPlan, exportDate: new Date().toISOString() };
    setExportData(JSON.stringify(data, null, 2));
    setShowExportModal(true);
  };

  const copyToClipboard = () => {
    navigator.clipboard.writeText(exportData).then(() => {
      alert('Data copied! Save it to a text file in Google Drive.');
      setShowExportModal(false);
    }).catch(() => alert('Failed to copy. Please select and copy manually.'));
  };

  const handleImport = (jsonText) => {
    try {
      const data = JSON.parse(jsonText);
      setRecipes(data.recipes || []);
      setMealPlan(data.mealPlan || []);
      alert('Data imported successfully!');
      setShowImportModal(false);
    } catch (error) {
      alert('Error importing data. Please check the format.');
    }
  };

  const allKeywords = [...new Set(recipes.flatMap(r => r.keywords || []))].sort();
  const filteredRecipes = recipes.filter(recipe => {
    const matchesSearch = recipe.name.toLowerCase().includes(searchTerm.toLowerCase());
    const matchesKeywords = selectedKeywords.length === 0 || selectedKeywords.every(kw => recipe.keywords?.includes(kw));
    return matchesSearch && matchesKeywords;
  });

  const toggleKeyword = (keyword) => {
    setSelectedKeywords(prev => prev.includes(keyword) ? prev.filter(k => k !== keyword) : [...prev, keyword]);
  };

  const saveRecipe = (recipe) => {
    if (editingRecipe?.id) {
      setRecipes(prev => prev.map(r => r.id === recipe.id ? recipe : r));
    } else {
      setRecipes(prev => [...prev, { ...recipe, id: Date.now() }]);
    }
    setEditingRecipe(null);
  };

  const deleteRecipe = (id) => {
    if (confirm('Are you sure you want to delete this recipe?')) {
      setRecipes(prev => prev.filter(r => r.id !== id));
      setMealPlan(prev => prev.filter(m => m.recipeId !== id));
    }
  };

  const addToMealPlan = (recipeId, date, mealType) => {
    const selectedDate = new Date(date);
    const dayOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][selectedDate.getDay()];
    setMealPlan(prev => [...prev, { recipeId, date, dayOfWeek, mealType }]);
    setShowMealPlanModal(false);
    setSelectedRecipeForPlan(null);
  };

  const openMealPlanModal = (recipeId) => {
    setSelectedRecipeForPlan(recipeId);
    setShowMealPlanModal(true);
  };

  const getWeekDays = () => {
    const days = [];
    let startDate = new Date();
    
    if (mealPlanView === 'thisWeek') {
      // Start from Monday of current week
      const dayOfWeek = startDate.getDay();
      const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // Handle Sunday
      startDate.setDate(startDate.getDate() + diff);
    } else if (mealPlanView === 'nextWeek') {
      // Start from Monday of next week
      const dayOfWeek = startDate.getDay();
      const diff = dayOfWeek === 0 ? 1 : 8 - dayOfWeek;
      startDate.setDate(startDate.getDate() + diff);
    } else if (mealPlanView === 'twoWeeks') {
      // Start from Monday of current week, show 14 days
      const dayOfWeek = startDate.getDay();
      const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
      startDate.setDate(startDate.getDate() + diff);
    }
    // else 'rolling' - starts from today
    
    const numDays = mealPlanView === 'twoWeeks' ? 14 : 7;
    
    for (let i = 0; i < numDays; i++) {
      const date = new Date(startDate);
      date.setDate(startDate.getDate() + i);
      days.push({
        date: date.toISOString().split('T')[0],
        dayOfWeek: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][date.getDay()],
        display: date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })
      });
    }
    return days;
  };

  const getMealsForDay = (date) => mealPlan.filter(meal => meal.date === date);

  const generateShoppingList = () => {
    const ingredients = {};
    mealPlan.forEach(meal => {
      const recipe = recipes.find(r => r.id === meal.recipeId);
      if (recipe?.ingredients) {
        recipe.ingredients.forEach(ing => {
          const key = `${ing.name}-${ing.unit}`;
          if (ingredients[key]) {
            ingredients[key].amount += parseFloat(ing.amount) || 0;
          } else {
            ingredients[key] = { name: ing.name, amount: parseFloat(ing.amount) || 0, unit: ing.unit, checked: false };
          }
        });
      }
    });
    setShoppingList(Object.values(ingredients));
    setView('shopping');
  };

  const showPrintView = (recipe) => {
    setPrintRecipe(recipe);
  };

  return (
    <div className="min-h-screen bg-gray-50">
      <div className="bg-white shadow">
        <div className="max-w-7xl mx-auto px-4 py-4">
          <div className="flex items-center justify-between mb-4">
            <h1 className="text-2xl font-bold text-gray-900">My Recipe Database</h1>
            <div className="flex gap-2">
              <button onClick={() => handleExport(false)} className="flex items-center gap-2 px-3 py-2 bg-gray-100 rounded hover:bg-gray-200">
                <Copy className="w-4 h-4" />Export (no images)
              </button>
              <button onClick={() => setShowImportModal(true)} className="flex items-center gap-2 px-3 py-2 bg-gray-100 rounded hover:bg-gray-200">
                <Upload className="w-4 h-4" />Import
              </button>
            </div>
          </div>
          <div className="flex gap-2">
            <button onClick={() => setView('recipes')} className={`flex items-center gap-2 px-4 py-2 rounded ${view === 'recipes' ? 'bg-blue-600 text-white' : 'bg-gray-100'}`}>
              <Search className="w-4 h-4" />Recipes
            </button>
            <button onClick={() => setView('meal-plan')} className={`flex items-center gap-2 px-4 py-2 rounded ${view === 'meal-plan' ? 'bg-blue-600 text-white' : 'bg-gray-100'}`}>
              <Calendar className="w-4 h-4" />Meal Plan ({mealPlan.length})
            </button>
            <button onClick={() => setView('shopping')} className={`flex items-center gap-2 px-4 py-2 rounded ${view === 'shopping' ? 'bg-blue-600 text-white' : 'bg-gray-100'}`}>
              <ShoppingCart className="w-4 h-4" />Shopping List
            </button>
          </div>
        </div>
      </div>

      <div className="max-w-7xl mx-auto px-4 py-6">
        {view === 'recipes' && (
          <div>
            <div className="mb-6 flex gap-4">
              <input type="text" placeholder="Search recipes..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="flex-1 px-4 py-2 border rounded" />
              <button onClick={() => setEditingRecipe({})} className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                <Plus className="w-4 h-4" />Add Recipe
              </button>
            </div>

            {allKeywords.length > 0 && (
              <div className="mb-6 flex flex-wrap gap-2">
                {allKeywords.map(kw => (
                  <button key={kw} onClick={() => toggleKeyword(kw)} className={`px-3 py-1 rounded text-sm ${selectedKeywords.includes(kw) ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}`}>{kw}</button>
                ))}
              </div>
            )}

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              {filteredRecipes.map(recipe => (
                <div key={recipe.id} className="bg-white rounded-lg shadow overflow-hidden">
                  {recipe.image ? <img src={recipe.image} alt={recipe.name} className="w-full h-48 object-cover" /> : <div className="w-full h-48 bg-gray-200 flex items-center justify-center text-gray-400">No Image</div>}
                  <div className="p-4">
                    <h3 className="font-bold text-lg mb-2">{recipe.name}</h3>
                    <div className="text-sm text-gray-600 mb-2 space-y-1">
                      {recipe.prepTime && <div>‚è±Ô∏è Prep: {recipe.prepTime} min</div>}
                      {recipe.cookTime && <div>üî• Cook: {recipe.cookTime} min</div>}
                      {recipe.serves && <div>üçΩÔ∏è Serves: {recipe.serves}</div>}
                      {recipe.source && <div>üìñ {recipe.source}</div>}
                    </div>
                    {recipe.recipeLink && (
                      <a href={recipe.recipeLink} target="_blank" rel="noopener noreferrer" className="text-xs text-blue-600 hover:underline flex items-center gap-1 mb-2">
                        <ExternalLink className="w-3 h-3" />Original Recipe
                      </a>
                    )}
                    <div className="flex flex-wrap gap-1 mb-3">
                      {recipe.keywords?.map(kw => <span key={kw} className="px-2 py-1 bg-gray-100 text-xs rounded">{kw}</span>)}
                    </div>
                    <div className="flex gap-2 flex-wrap">
                      <button onClick={() => showPrintView(recipe)} className="flex items-center gap-1 px-3 py-1 bg-gray-100 rounded text-sm hover:bg-gray-200">
                        <Printer className="w-3 h-3" />Print
                      </button>
                      <button onClick={() => openMealPlanModal(recipe.id)} className="flex items-center gap-1 px-3 py-1 bg-blue-100 rounded text-sm hover:bg-blue-200">
                        <Plus className="w-3 h-3" />Plan
                      </button>
                      <button onClick={() => setEditingRecipe(recipe)} className="flex items-center gap-1 px-3 py-1 bg-yellow-100 rounded text-sm hover:bg-yellow-200">
                        <Edit2 className="w-3 h-3" />
                      </button>
                      <button onClick={() => deleteRecipe(recipe.id)} className="flex items-center gap-1 px-3 py-1 bg-red-100 rounded text-sm hover:bg-red-200">
                        <Trash2 className="w-3 h-3" />
                      </button>
                    </div>
                  </div>
                </div>
              ))}
            </div>
            {filteredRecipes.length === 0 && <div className="text-center py-12 text-gray-500">No recipes found. Add your first recipe to get started!</div>}
          </div>
        )}

        {view === 'meal-plan' && (
          <div>
            <div className="flex justify-between items-center mb-6">
              <h2 className="text-xl font-bold">Meal Plan</h2>
              <div className="flex gap-2">
                <select 
                  value={mealPlanView} 
                  onChange={(e) => setMealPlanView(e.target.value)}
                  className="px-3 py-2 border rounded"
                >
                  <option value="rolling">Next 7 Days</option>
                  <option value="thisWeek">This Week (Mon-Sun)</option>
                  <option value="nextWeek">Next Week (Mon-Sun)</option>
                  <option value="twoWeeks">Next 2 Weeks</option>
                </select>
                <button onClick={() => setPrintMealPlan(true)} className="flex items-center gap-2 px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">
                  <Printer className="w-4 h-4" />Print Plan
                </button>
                <button onClick={generateShoppingList} className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                  <ShoppingCart className="w-4 h-4" />Generate Shopping List
                </button>
              </div>
            </div>
            <div className="space-y-4">
              {getWeekDays().map(day => {
                const mealsForDay = getMealsForDay(day.date);
                return (
                  <div key={day.date} className="bg-white rounded-lg shadow">
                    <div className="bg-gray-100 px-4 py-3 font-semibold border-b">{day.display}</div>
                    <div className="p-4">
                      {['breakfast', 'lunch', 'dinner', 'snack'].map(mealType => {
                        const meal = mealsForDay.find(m => m.mealType === mealType);
                        const recipe = meal ? recipes.find(r => r.id === meal.recipeId) : null;
                        return (
                          <div key={mealType} className="flex items-center gap-4 py-2 border-b last:border-b-0">
                            <div className="w-24 text-sm font-medium text-gray-600 capitalize">{mealType}</div>
                            {meal && recipe ? (
                              <div className="flex-1 flex items-center justify-between">
                                <div>
                                  <div className="font-medium">{recipe.name}</div>
                                  {recipe.prepTime && recipe.cookTime && <div className="text-xs text-gray-500">{parseInt(recipe.prepTime) + parseInt(recipe.cookTime)} min total</div>}
                                </div>
                                <button onClick={() => setMealPlan(prev => prev.filter(m => m !== meal))} className="p-2 text-red-600 hover:bg-red-50 rounded">
                                  <X className="w-4 h-4" />
                                </button>
                              </div>
                            ) : <div className="flex-1 text-sm text-gray-400">No meal planned</div>}
                          </div>
                        );
                      })}
                    </div>
                  </div>
                );
              })}
            </div>
            {mealPlan.length === 0 && <div className="bg-white rounded-lg shadow p-8 text-center text-gray-500">No meals planned yet. Add recipes from the Recipes view.</div>}
          </div>
        )}

        {view === 'shopping' && (
          <div>
            <div className="flex justify-between items-center mb-6">
              <h2 className="text-xl font-bold">Shopping List</h2>
              <button onClick={() => setPrintShoppingList(true)} className="flex items-center gap-2 px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">
                <Printer className="w-4 h-4" />Print List
              </button>
            </div>
            <div className="bg-white rounded-lg shadow p-4">
              {shoppingList.map((item, idx) => (
                <div key={idx} className="flex items-center gap-3 py-2 border-b last:border-b-0">
                  <input type="checkbox" checked={item.checked} onChange={() => setShoppingList(prev => prev.map((it, i) => i === idx ? { ...it, checked: !it.checked } : it))} className="w-5 h-5" />
                  <span className={item.checked ? 'line-through text-gray-400' : ''}>{item.amount} {item.unit} {item.name}</span>
                </div>
              ))}
              {shoppingList.length === 0 && <div className="py-8 text-center text-gray-500">No shopping list yet. Generate one from your meal plan.</div>}
            </div>
          </div>
        )}

        {editingRecipe && <RecipeEditor recipe={editingRecipe} onSave={saveRecipe} onCancel={() => setEditingRecipe(null)} />}

        {showExportModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div className="bg-white rounded-lg max-w-2xl w-full p-6">
              <h2 className="text-xl font-bold mb-4">Export Your Recipes</h2>
              <p className="text-sm text-gray-600 mb-4">
                Copy this data and save it to a text file in Google Drive. 
                <strong className="block mt-2">Note: Images are excluded to keep the file size manageable. You'll need to re-add images after importing.</strong>
              </p>
              <textarea value={exportData} readOnly className="w-full h-64 px-3 py-2 border rounded font-mono text-xs mb-4" onClick={(e) => e.target.select()} />
              <div className="flex gap-3">
                <button onClick={copyToClipboard} className="flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                  <Copy className="w-4 h-4" />Copy to Clipboard
                </button>
                <button onClick={() => setShowExportModal(false)} className="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Close</button>
              </div>
            </div>
          </div>
        )}

        {showImportModal && <ImportModal onImport={handleImport} onCancel={() => setShowImportModal(false)} />}

        {showMealPlanModal && selectedRecipeForPlan && (
          <MealPlanModal
            recipe={recipes.find(r => r.id === selectedRecipeForPlan)}
            onAdd={addToMealPlan}
            onCancel={() => {
              setShowMealPlanModal(false);
              setSelectedRecipeForPlan(null);
            }}
            getWeekDays={getWeekDays}
          />
        )}

        {printRecipe && <PrintView recipe={printRecipe} onClose={() => setPrintRecipe(null)} />}
        
        {printMealPlan && (
          <PrintMealPlanView 
            weekDays={getWeekDays()} 
            mealPlan={mealPlan} 
            recipes={recipes}
            onClose={() => setPrintMealPlan(false)} 
          />
        )}
        
        {printShoppingList && (
          <PrintShoppingListView 
            shoppingList={shoppingList} 
            onClose={() => setPrintShoppingList(false)} 
          />
        )}
      </div>
    </div>
  );
};

const ImportModal = ({ onImport, onCancel }) => {
  const [importText, setImportText] = useState('');
  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
      <div className="bg-white rounded-lg max-w-2xl w-full p-6">
        <h2 className="text-xl font-bold mb-4">Import Your Recipes</h2>
        <p className="text-sm text-gray-600 mb-4">Paste the JSON data you previously exported:</p>
        <textarea value={importText} onChange={(e) => setImportText(e.target.value)} placeholder="Paste your exported recipe data here..." className="w-full h-64 px-3 py-2 border rounded font-mono text-xs mb-4" />
        <div className="flex gap-3">
          <button onClick={() => onImport(importText)} className="flex-1 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Import Data</button>
          <button onClick={onCancel} className="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Cancel</button>
        </div>
      </div>
    </div>
  );
};

const MealPlanModal = ({ recipe, onAdd, onCancel, getWeekDays }) => {
  const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
  const [selectedMealType, setSelectedMealType] = useState('dinner');
  
  const weekDays = getWeekDays();
  
  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
      <div className="bg-white rounded-lg max-w-md w-full p-6">
        <h2 className="text-xl font-bold mb-4">Add to Meal Plan</h2>
        <p className="text-sm text-gray-600 mb-4">
          <strong>{recipe.name}</strong>
        </p>
        
        <div className="space-y-4">
          <div>
            <label className="block font-semibold mb-2">Select Day</label>
            <select 
              value={selectedDate} 
              onChange={(e) => setSelectedDate(e.target.value)}
              className="w-full px-3 py-2 border rounded"
            >
              {weekDays.map(day => (
                <option key={day.date} value={day.date}>{day.display}</option>
              ))}
            </select>
          </div>
          
          <div>
            <label className="block font-semibold mb-2">Select Meal</label>
            <div className="grid grid-cols-2 gap-2">
              {['breakfast', 'lunch', 'dinner', 'snack'].map(meal => (
                <button
                  key={meal}
                  onClick={() => setSelectedMealType(meal)}
                  className={`px-4 py-2 rounded capitalize ${
                    selectedMealType === meal 
                      ? 'bg-blue-600 text-white' 
                      : 'bg-gray-100 hover:bg-gray-200'
                  }`}
                >
                  {meal}
                </button>
              ))}
            </div>
          </div>
        </div>
        
        <div className="flex gap-3 mt-6">
          <button 
            onClick={() => onAdd(recipe.id, selectedDate, selectedMealType)} 
            className="flex-1 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
          >
            Add to Plan
          </button>
          <button onClick={onCancel} className="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">
            Cancel
          </button>
        </div>
      </div>
    </div>
  );
};

const PrintView = ({ recipe, onClose }) => {
  const handlePrint = () => {
    window.print();
  };

  return (
    <div className="fixed inset-0 bg-white z-50 overflow-auto">
      <style>{`
        @media print {
          .no-print { display: none !important; }
          @page { size: A4; margin: 0; }
        }
        .print-container {
          font-family: Arial, sans-serif;
          font-size: 10pt;
        }
        .recipe-half {
          height: 50vh;
          padding: 1cm;
          box-sizing: border-box;
        }
        .recipe-half h1 {
          font-size: 14pt;
          margin: 0 0 0.3cm 0;
          border-bottom: 2px solid #333;
          padding-bottom: 0.2cm;
        }
        .recipe-half .info-grid {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 0.2cm;
          margin-bottom: 0.4cm;
          font-size: 9pt;
        }
        .recipe-half .keywords {
          color: #666;
          font-size: 8pt;
          margin-bottom: 0.3cm;
        }
        .recipe-half h2 {
          font-size: 11pt;
          margin: 0.4cm 0 0.2cm 0;
          color: #333;
        }
        .recipe-half ul, .recipe-half ol {
          margin: 0;
          padding-left: 1.2em;
        }
        .recipe-half li {
          margin-bottom: 0.15cm;
          font-size: 9pt;
        }
        .recipe-half .nutrition {
          font-size: 8pt;
          color: #666;
          margin-top: 0.3cm;
          padding-top: 0.3cm;
          border-top: 1px solid #ccc;
        }
        .cut-line {
          text-align: center;
          color: #999;
          font-size: 8pt;
          padding: 0.2cm 0;
          border-top: 1px dashed #999;
        }
      `}</style>

      <div className="no-print fixed top-4 right-4 bg-white p-4 rounded-lg shadow-lg border-2 border-gray-300 flex gap-3">
        <button
          onClick={handlePrint}
          className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
        >
          <Printer className="w-4 h-4" />
          Print (Ctrl+P / Cmd+P)
        </button>
        <button
          onClick={onClose}
          className="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300"
        >
          Close
        </button>
      </div>

      <div className="print-container">
        <div className="recipe-half">
          <h1>{recipe.name}</h1>
          <div className="info-grid">
            {recipe.prepTime && <div><strong>Prep:</strong> {recipe.prepTime} min</div>}
            {recipe.cookTime && <div><strong>Cook:</strong> {recipe.cookTime} min</div>}
            {recipe.serves && <div><strong>Serves:</strong> {recipe.serves}</div>}
            {recipe.source && <div><strong>Source:</strong> {recipe.source}</div>}
          </div>
          {recipe.keywords?.length > 0 && <div className="keywords">{recipe.keywords.join(', ')}</div>}
          <h2>Ingredients</h2>
          <ul>
            {recipe.ingredients?.map((i, idx) => (
              <li key={idx}>{i.amount} {i.unit} {i.name}</li>
            ))}
          </ul>
          <h2>Steps</h2>
          <ol>
            {recipe.steps?.map((s, idx) => (
              <li key={idx}>{s}</li>
            ))}
          </ol>
          {recipe.nutrition && <div className="nutrition">Nutrition: {recipe.nutrition}</div>}
        </div>

        <div className="cut-line">‚úÇ Cut along this line ‚úÇ</div>

        <div className="recipe-half">
          <h1>{recipe.name}</h1>
          <div className="info-grid">
            {recipe.prepTime && <div><strong>Prep:</strong> {recipe.prepTime} min</div>}
            {recipe.cookTime && <div><strong>Cook:</strong> {recipe.cookTime} min</div>}
            {recipe.serves && <div><strong>Serves:</strong> {recipe.serves}</div>}
            {recipe.source && <div><strong>Source:</strong> {recipe.source}</div>}
          </div>
          {recipe.keywords?.length > 0 && <div className="keywords">{recipe.keywords.join(', ')}</div>}
          <h2>Ingredients</h2>
          <ul>
            {recipe.ingredients?.map((i, idx) => (
              <li key={idx}>{i.amount} {i.unit} {i.name}</li>
            ))}
          </ul>
          <h2>Steps</h2>
          <ol>
            {recipe.steps?.map((s, idx) => (
              <li key={idx}>{s}</li>
            ))}
          </ol>
          {recipe.nutrition && <div className="nutrition">Nutrition: {recipe.nutrition}</div>}
        </div>
      </div>
    </div>
  );
};

const PrintMealPlanView = ({ weekDays, mealPlan, recipes, onClose }) => {
  const getMealsForDay = (date) => mealPlan.filter(meal => meal.date === date);

  return (
    <div className="fixed inset-0 bg-white z-50 overflow-auto">
      <style>{`
        @media print {
          .no-print { display: none !important; }
          @page { size: A4; margin: 1.5cm; }
        }
        .meal-plan-print {
          font-family: Arial, sans-serif;
          padding: 1cm;
        }
        .meal-plan-print h1 {
          font-size: 18pt;
          margin-bottom: 1cm;
          text-align: center;
          border-bottom: 3px solid #333;
          padding-bottom: 0.5cm;
        }
        .day-section {
          margin-bottom: 0.8cm;
          page-break-inside: avoid;
        }
        .day-header {
          font-size: 14pt;
          font-weight: bold;
          background: #f0f0f0;
          padding: 0.3cm;
          margin-bottom: 0.3cm;
        }
        .meal-row {
          display: grid;
          grid-template-columns: 120px 1fr;
          padding: 0.2cm 0;
          border-bottom: 1px solid #ddd;
        }
        .meal-type {
          font-weight: bold;
          text-transform: capitalize;
        }
        .meal-name {
          color: #333;
        }
        .meal-time {
          font-size: 9pt;
          color: #666;
        }
      `}</style>

      <div className="no-print fixed top-4 right-4 bg-white p-4 rounded-lg shadow-lg border-2 border-gray-300 flex gap-3">
        <button onClick={() => window.print()} className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
          <Printer className="w-4 h-4" />Print (Ctrl+P / Cmd+P)
        </button>
        <button onClick={onClose} className="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Close</button>
      </div>

      <div className="meal-plan-print">
        <h1>Meal Plan</h1>
        {weekDays.map(day => {
          const mealsForDay = getMealsForDay(day.date);
          return (
            <div key={day.date} className="day-section">
              <div className="day-header">{day.display}</div>
              {['breakfast', 'lunch', 'dinner', 'snack'].map(mealType => {
                const meal = mealsForDay.find(m => m.mealType === mealType);
                const recipe = meal ? recipes.find(r => r.id === meal.recipeId) : null;
                return (
                  <div key={mealType} className="meal-row">
                    <div className="meal-type">{mealType}</div>
                    <div>
                      {recipe ? (
                        <>
                          <div className="meal-name">{recipe.name}</div>
                          {recipe.prepTime && recipe.cookTime && (
                            <div className="meal-time">{parseInt(recipe.prepTime) + parseInt(recipe.cookTime)} min total</div>
                          )}
                        </>
                      ) : (
                        <div style={{color: '#999'}}>‚Äî</div>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
          );
        })}
      </div>
    </div>
  );
};

const PrintShoppingListView = ({ shoppingList, onClose }) => {
  return (
    <div className="fixed inset-0 bg-white z-50 overflow-auto">
      <style>{`
        @media print {
          .no-print { display: none !important; }
          @page { size: A4; margin: 1.5cm; }
        }
        .shopping-list-print {
          font-family: Arial, sans-serif;
          padding: 1cm;
        }
        .shopping-list-print h1 {
          font-size: 18pt;
          margin-bottom: 1cm;
          text-align: center;
          border-bottom: 3px solid #333;
          padding-bottom: 0.5cm;
        }
        .shopping-item {
          display: flex;
          align-items: center;
          padding: 0.3cm 0;
          border-bottom: 1px solid #ddd;
          font-size: 11pt;
        }
        .checkbox {
          width: 0.5cm;
          height: 0.5cm;
          border: 2px solid #333;
          margin-right: 0.5cm;
          flex-shrink: 0;
        }
      `}</style>

      <div className="no-print fixed top-4 right-4 bg-white p-4 rounded-lg shadow-lg border-2 border-gray-300 flex gap-3">
        <button onClick={() => window.print()} className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
          <Printer className="w-4 h-4" />Print (Ctrl+P / Cmd+P)
        </button>
        <button onClick={onClose} className="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Close</button>
      </div>

      <div className="shopping-list-print">
        <h1>Shopping List</h1>
        {shoppingList.map((item, idx) => (
          <div key={idx} className="shopping-item">
            <div className="checkbox"></div>
            <div>{item.amount} {item.unit} {item.name}</div>
          </div>
        ))}
        {shoppingList.length === 0 && (
          <div style={{textAlign: 'center', color: '#999', marginTop: '2cm'}}>No items in shopping list</div>
        )}
      </div>
    </div>
  );
};

const RecipeEditor = ({ recipe, onSave, onCancel }) => {
  const [formData, setFormData] = useState({
    name: recipe.name || '',
    keywords: recipe.keywords?.join(', ') || '',
    prepTime: recipe.prepTime || '',
    cookTime: recipe.cookTime || '',
    serves: recipe.serves || '',
    source: recipe.source || '',
    recipeLink: recipe.recipeLink || '',
    ingredients: recipe.ingredients || [{ name: '', amount: '', unit: 'g' }],
    steps: recipe.steps?.join('\n') || '',
    nutrition: recipe.nutrition || '',
    image: recipe.image || ''
  });

  const units = ['g', 'kg', 'oz', 'lb', 'ml', 'l', 'cup', 'tbsp', 'tsp', 'piece', 'whole', 'each'];

  const handleImageUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        const img = new Image();
        img.onload = () => {
          // Create canvas to resize image
          const canvas = document.createElement('canvas');
          const maxWidth = 800; // pixels (approx 8cm at 96 DPI)
          const maxHeight = 600; // pixels (approx 6cm at 96 DPI)
          
          let width = img.width;
          let height = img.height;
          
          // Calculate new dimensions maintaining aspect ratio
          if (width > height) {
            if (width > maxWidth) {
              height = (height * maxWidth) / width;
              width = maxWidth;
            }
          } else {
            if (height > maxHeight) {
              width = (width * maxHeight) / height;
              height = maxHeight;
            }
          }
          
          canvas.width = width;
          canvas.height = height;
          
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);
          
          // Convert to base64 with compression
          const resizedImage = canvas.toDataURL('image/jpeg', 0.85);
          setFormData({ ...formData, image: resizedImage });
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    }
  };

  const addIngredient = () => setFormData({ ...formData, ingredients: [...formData.ingredients, { name: '', amount: '', unit: 'g' }] });
  const updateIngredient = (index, field, value) => {
    const newIngredients = [...formData.ingredients];
    newIngredients[index][field] = value;
    setFormData({ ...formData, ingredients: newIngredients });
  };
  const removeIngredient = (index) => setFormData({ ...formData, ingredients: formData.ingredients.filter((_, i) => i !== index) });

  const handleSubmit = () => {
    if (!formData.name.trim()) return alert('Please enter a recipe name');
    const validIngredients = formData.ingredients.filter(ing => ing.name.trim());
    if (validIngredients.length === 0) return alert('Please add at least one ingredient');
    onSave({
      ...recipe,
      name: formData.name,
      keywords: formData.keywords.split(',').map(k => k.trim()).filter(Boolean),
      prepTime: formData.prepTime,
      cookTime: formData.cookTime,
      serves: formData.serves,
      source: formData.source,
      recipeLink: formData.recipeLink,
      ingredients: validIngredients,
      steps: formData.steps.split('\n').filter(Boolean),
      nutrition: formData.nutrition,
      image: formData.image
    });
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center p-4 z-50 overflow-y-auto py-8">
      <div className="bg-white rounded-lg max-w-4xl w-full my-8">
        <div className="p-6 border-b sticky top-0 bg-white z-10 rounded-t-lg">
          <h2 className="text-2xl font-bold">{recipe.id ? 'Edit Recipe' : 'New Recipe'}</h2>
        </div>
        <div className="p-6 space-y-4">
          <div className="grid grid-cols-2 gap-4">
            <div className="col-span-2">
              <label className="block font-semibold mb-1">Recipe Name *</label>
              <input type="text" value={formData.name} onChange={(e) => setFormData({ ...formData, name: e.target.value })} className="w-full px-3 py-2 border rounded" />
            </div>
            <div>
              <label className="block font-semibold mb-1">Prep Time (min)</label>
              <input type="number" value={formData.prepTime} onChange={(e) => setFormData({ ...formData, prepTime: e.target.value })} className="w-full px-3 py-2 border rounded" placeholder="30" />
            </div>
            <div>
              <label className="block font-semibold mb-1">Cook Time (min)</label>
              <input type="number" value={formData.cookTime} onChange={(e) => setFormData({ ...formData, cookTime: e.target.value })} className="w-full px-3 py-2 border rounded" placeholder="45" />
            </div>
            <div>
              <label className="block font-semibold mb-1">Serves</label>
              <input type="text" value={formData.serves} onChange={(e) => setFormData({ ...formData, serves: e.target.value })} className="w-full px-3 py-2 border rounded" placeholder="4" />
            </div>
            <div>
              <label className="block font-semibold mb-1">Source</label>
              <input type="text" value={formData.source} onChange={(e) => setFormData({ ...formData, source: e.target.value })} className="w-full px-3 py-2 border rounded" placeholder="Jamie Oliver" />
            </div>
            <div className="col-span-2">
              <label className="block font-semibold mb-1">Original Recipe Link</label>
              <input type="url" value={formData.recipeLink} onChange={(e) => setFormData({ ...formData, recipeLink: e.target.value })} className="w-full px-3 py-2 border rounded" placeholder="https://example.com/recipe" />
            </div>
          </div>
          <div>
            <label className="block font-semibold mb-1">Recipe Image</label>
            {formData.image && (
              <div className="mb-2">
                <img src={formData.image} alt="Preview" className="w-full h-48 object-cover rounded" />
                <button onClick={() => setFormData({ ...formData, image: '' })} className="mt-2 text-sm text-red-600 hover:text-red-700">Remove Image</button>
              </div>
            )}
            <input type="file" accept="image/*" onChange={handleImageUpload} className="w-full px-3 py-2 border rounded" />
          </div>
          <div>
            <label className="block font-semibold mb-1">Keywords (comma-separated)</label>
            <input type="text" value={formData.keywords} onChange={(e) => setFormData({ ...formData, keywords: e.target.value })} placeholder="vegetarian, quick, dinner" className="w-full px-3 py-2 border rounded" />
          </div>
          <div>
            <label className="block font-semibold mb-2">Ingredients *</label>
            <div className="space-y-2">
              {formData.ingredients.map((ing, idx) => (
                <div key={idx} className="flex gap-2">
                  <input type="number" value={ing.amount} onChange={(e) => updateIngredient(idx, 'amount', e.target.value)} placeholder="250" className="w-24 px-3 py-2 border rounded" />
                  <select value={ing.unit} onChange={(e) => updateIngredient(idx, 'unit', e.target.value)} className="w-28 px-3 py-2 border rounded">
                    {units.map(unit => <option key={unit} value={unit}>{unit}</option>)}
                  </select>
                  <input type="text" value={ing.name} onChange={(e) => updateIngredient(idx, 'name', e.target.value)} placeholder="flour, eggs..." className="flex-1 px-3 py-2 border rounded" />
                  <button onClick={() => removeIngredient(idx)} className="px-3 py-2 bg-red-100 text-red-600 rounded hover:bg-red-200">
                    <X className="w-4 h-4" />
                  </button>
                </div>
              ))}
              <button onClick={addIngredient} className="flex items-center gap-2 px-3 py-2 bg-green-100 text-green-700 rounded hover:bg-green-200">
                <Plus className="w-4 h-4" />Add Ingredient
              </button>
            </div>
          </div>
          <div>
            <label className="block font-semibold mb-1">Steps (one per line) *</label>
            <textarea value={formData.steps} onChange={(e) => setFormData({ ...formData, steps: e.target.value })} className="w-full px-3 py-2 border rounded h-32" placeholder="1. Preheat oven&#10;2. Mix ingredients..." />
          </div>
          <div>
            <label className="block font-semibold mb-1">Nutrition Info</label>
            <input type="text" value={formData.nutrition} onChange={(e) => setFormData({ ...formData, nutrition: e.target.value })} placeholder="450 cal, 25g protein per serving" className="w-full px-3 py-2 border rounded" />
          </div>
        </div>
        <div className="flex gap-3 p-6 border-t sticky bottom-0 bg-white rounded-b-lg">
          <button onClick={handleSubmit} className="flex-1 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Save Recipe</button>
          <button onClick={onCancel} className="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Cancel</button>
        </div>
      </div>
    </div>
  );
};

export default RecipeManager;
